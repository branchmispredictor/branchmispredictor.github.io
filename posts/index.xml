<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on branchmispredictor</title><link>https://branchmispredictor.github.io/posts/</link><description>Recent content in Posts on branchmispredictor</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 04 Nov 2021 23:30:42 -0400</lastBuildDate><atom:link href="https://branchmispredictor.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Fixing LSI SAS Card After Kernel Upgrade</title><link>https://branchmispredictor.github.io/posts/fixing-lsi-sas-card-new-kernel/</link><pubDate>Thu, 04 Nov 2021 23:30:42 -0400</pubDate><guid>https://branchmispredictor.github.io/posts/fixing-lsi-sas-card-new-kernel/</guid><description>&lt;p>After updating my Arch Linux server to kernel version 5.14.14, all of the drives attached through a LSI SAS Card (LSISAS2116) disappeared.&lt;/p>
&lt;p>&lt;strong>TL;DR:&lt;/strong> The fix was to add &lt;code>mpt3sas.max_queue_depth=10000&lt;/code> as a kernel param.&lt;/p>
&lt;h2 id="investigation">Investigation&lt;/h2>
&lt;p>The lines in question via dmesg:&lt;/p>
&lt;pre tabindex="0">&lt;code>mpt2sas_cm0: sense pool(0x(____ptrval____)) - dma(0x10d000000): depth(29868), element_size(96), pool_size (2800 kB)
mpt2sas_cm0: sense pool(0x(____ptrval____))- dma(0x10d000000): depth(29868),element_size(96), pool_size(0 kB)
mpt2sas_cm0: reply pool(0x(____ptrval____)) - dma(0x10d400000): depth(30191), frame_size(128), pool_size(3773 kB)
mpt2sas_cm0: config page(0x(____ptrval____)) - dma(0x10cfc9000): size(512)
mpt2sas_cm0: Allocated physical memory: size(66932 kB)
mpt2sas_cm0: Current Controller Queue Depth(29865),Max Controller Queue Depth(32455)
mpt2sas_cm0: Scatter Gather Elements per IO(128)
random: fast init done
mpt2sas_cm0: LSISAS2116: FWVersion(20.00.07.00), ChipRevision(0x02), BiosVersion(07.39.02.00)
mpt2sas_cm0: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)
scsi host10: Fusion MPT SAS Host
blk-mq: reduced tag depth to 10240
mpt2sas_cm0: sending port enable !!
mpt3sas 0000:02:00.0: can't disable ASPM; OS doesn't have ASPM control
mpt2sas_cm1: 64 BIT PCI BUS DMA ADDRESSING SUPPORTED, total mem (12138696 kB)
mpt2sas_cm0: hba_port entry: (____ptrval____), port: 255 is added to hba_port list
mpt2sas_cm0: host_add: handle(0x0001), sas_addr(0x500062b20028efc0), phys(16)
mpt2sas_cm0: expander_add: handle(0x0011), parent(0x0001), sas_addr(0x5001438022c73126), phys(37)
expander-10:0: add: handle(0x0011), sas_addr(0x5001438022c73126)
------------[ cut here ]------------
WARNING: CPU: 6 PID: 128 at mm/page_alloc.c:5367 __alloc_pages+0x210/0x230
Modules linked in: crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel crypto_simd cryptd mpt3sas(+) &amp;gt;
CPU: 6 PID: 128 Comm: kworker/u16:3 Not tainted 5.14.14-arch1-1 #1 3033d1ff40825c3916f6297baa2f1c356df9db26
Hardware name: Gigabyte Technology Co., Ltd. To be filled by O.E.M./Z68XP-UD4, BIOS U1L 03/06/2013
Workqueue: fw_event_mpt2sas0 _firmware_event_work [mpt3sas]
RIP: 0010:__alloc_pages+0x210/0x230
Code: 8d 54 24 08 44 89 ee 89 ef 89 6c 24 04 c6 44 24 28 00 48 89 5c 24 10 e8 0e f1 ff ff 49 89 c4 e9 f0 fe ff ff 40 80 e5 3&amp;gt;
RSP: 0018:ffffb75980507938 EFLAGS: 00010246
RAX: 0000000000000000 RBX: 00000000000074a9 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 000000000000000b RDI: 0000000000040dc0
RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000140 R11: 0000000000000000 R12: 0000000000000000
R13: 000000000000000b R14: 0000000000577ec0 R15: 0000000000000140
FS: 0000000000000000(0000) GS:ffff9ecd93380000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f7e38cd1bf0 CR3: 00000002c9410002 CR4: 00000000000606e0
Call Trace:
kmalloc_large_node+0x40/0xb0
__kmalloc_node+0x305/0x3b0
sbitmap_init_node+0x7f/0x1e0
scsi_alloc_sdev+0x2b2/0x350
scsi_probe_and_add_lun+0x9b9/0xdf0
__scsi_scan_target+0xa2/0x5a0
? __pm_runtime_resume+0x58/0x80
scsi_scan_target+0xd7/0xf0
sas_rphy_add+0x126/0x170 [scsi_transport_sas d494b7ec27527bf0e737feb713a5a5b6ecd159d2]
mpt3sas_transport_port_add+0x316/0x4a0 [mpt3sas c250154050dc3e3e76222987e48f6fd033eada1e]
_scsih_add_device.constprop.0+0x441/0x550 [mpt3sas c250154050dc3e3e76222987e48f6fd033eada1e]
_firmware_event_work+0xe17/0x1ed0 [mpt3sas c250154050dc3e3e76222987e48f6fd033eada1e]
? psi_task_switch+0xc2/0x1f0
? __switch_to_asm+0x42/0x70
? finish_task_switch.isra.0+0xaa/0x290
process_one_work+0x1e3/0x3b0
worker_thread+0x50/0x3b0
? process_one_work+0x3b0/0x3b0
kthread+0x132/0x160
? set_kthread_struct+0x40/0x40
ret_from_fork+0x22/0x30
---[ end trace 79fad68877b70d38 ]---
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:0: add: handle(0x0012), sas_addr(0x5001438022c7310c)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:1: add: handle(0x0013), sas_addr(0x5001438022c7310d)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:2: add: handle(0x0014), sas_addr(0x5001438022c7310e)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:3: add: handle(0x0015), sas_addr(0x5001438022c7310f)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:4: add: handle(0x0016), sas_addr(0x5001438022c73110)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:5: add: handle(0x0017), sas_addr(0x5001438022c73111)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:6: add: handle(0x0018), sas_addr(0x5001438022c73112)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:7: add: handle(0x0019), sas_addr(0x5001438022c73113)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:8: add: handle(0x001a), sas_addr(0x5001438022c73117)
scsi_alloc_sdev: Allocation failure during SCSI scanning, some SCSI devices might not be configured
end_device-10:0:9: add: handle(0x001b), sas_addr(0x5001438022c73125)
mpt2sas_cm0: port enable: SUCCESS
mpt2sas_cm1: CurrentHostPageSize is 0: Setting default host page size to 4k
&lt;/code>&lt;/pre>&lt;p>After some searching, I stumbled upon &lt;a href="https://bugzilla.kernel.org/show_bug.cgi?id=209177">https://bugzilla.kernel.org/show_bug.cgi?id=209177&lt;/a>.
Notably it talks about a similar but not exactly the same error where mpt3sas fails to initialize due to a failed allocation.&lt;/p>
&lt;p>In my own logs, I noticed the controlled queue depth was quite large just as in that bug report: &lt;code>Current Controller Queue Depth(29865),Max Controller Queue Depth(32455)&lt;/code>.&lt;/p>
&lt;h2 id="the-fix">The Fix&lt;/h2>
&lt;p>The fix was to add &lt;code>mpt3sas.max_queue_depth=10000&lt;/code> as a kernel param. As I am using GRUB, this meant editing &lt;code>GRUB_CMDLINE_LINUX&lt;/code> in &lt;code>/etc/default/grub&lt;/code> and then running &lt;code>sudo grub-mkconfig -o /boot/grub/grub.cfg&lt;/code>.&lt;/p>
&lt;p>Now mpt3sas initializes correctly:&lt;/p>
&lt;pre tabindex="0">&lt;code>mpt2sas_cm0: sense pool(0x(____ptrval____)) - dma(0x10aa00000): depth(10000), element_size(96), pool_size (937 kB)
mpt2sas_cm0: sense pool(0x(____ptrval____))- dma(0x10aa00000): depth(10000),element_size(96), pool_size(0 kB)
mpt2sas_cm0: reply pool(0x(____ptrval____)) - dma(0x109600000): depth(10323), frame_size(128), pool_size(1290 kB)
mpt2sas_cm0: config page(0x(____ptrval____)) - dma(0x10a986000): size(512)
mpt2sas_cm0: Allocated physical memory: size(22462 kB)
mpt2sas_cm0: Current Controller Queue Depth(9997),Max Controller Queue Depth(32455)
mpt2sas_cm0: Scatter Gather Elements per IO(128)
random: fast init done
mpt2sas_cm0: LSISAS2116: FWVersion(20.00.07.00), ChipRevision(0x02), BiosVersion(07.39.02.00)
mpt2sas_cm0: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)
scsi host10: Fusion MPT SAS Host
mpt2sas_cm0: sending port enable !!
mpt3sas 0000:02:00.0: can't disable ASPM; OS doesn't have ASPM control
mpt2sas_cm1: 64 BIT PCI BUS DMA ADDRESSING SUPPORTED, total mem (12138696 kB)
mpt2sas_cm0: hba_port entry: (____ptrval____), port: 255 is added to hba_port list
mpt2sas_cm0: host_add: handle(0x0001), sas_addr(0x500062b20028efc0), phys(16)
mpt2sas_cm0: expander_add: handle(0x0011), parent(0x0001), sas_addr(0x5001438022c73126), phys(37)
expander-10:0: add: handle(0x0011), sas_addr(0x5001438022c73126)
scsi 10:0:0:0: Direct-Access ATA WDC WD100EMAZ-00 0A83 PQ: 0 ANSI: 6
scsi 10:0:0:0: SATA: handle(0x0012), sas_addr(0x5001438022c7310c), phy(12), device_name(0x5000cca267c94f7f)
scsi 10:0:0:0: enclosure logical id (0x5001438022c73125), slot(47)
scsi 10:0:0:0: atapi(n), ncq(y), asyn_notify(n), smart(y), fua(y), sw_preserve(y)
scsi 10:0:0:0: qdepth(32), tagged(1), scsi_level(7), cmd_que(1)
end_device-10:0:0: add: handle(0x0012), sas_addr(0x5001438022c7310c)
...
mpt2sas_cm0: port enable: SUCCESS&lt;/code>&lt;/pre></description></item></channel></rss>