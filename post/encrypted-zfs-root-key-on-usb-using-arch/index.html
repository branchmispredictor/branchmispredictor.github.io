<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Encrypted ZFS Root Key on USB using Arch | branchmispredictor</title>
<meta name=keywords content="arch,linux,zfs"><meta name=description content="This is an initcpio hook that loads your root pool zfs password from a usb stick, as an alternative to modifying the zfs initcpio hook as mentioned in https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick.
This hook can also be used in ZFSBootMenu, meaning the same code and same usb can unlock your root pool in ZFSBootMenu and Linux itself. This solution does not store your key in initramfs.
Generate the Password + Write to the USB Generate your zfs password and put it on a usb drive using DD, see the first two steps: https://wiki."><meta name=author content="branchmispredictor"><link rel=canonical href=https://branchmispredictor.github.io/post/encrypted-zfs-root-key-on-usb-using-arch/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://branchmispredictor.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://branchmispredictor.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://branchmispredictor.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://branchmispredictor.github.io/apple-touch-icon.png><link rel=mask-icon href=https://branchmispredictor.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Encrypted ZFS Root Key on USB using Arch"><meta property="og:description" content="This is an initcpio hook that loads your root pool zfs password from a usb stick, as an alternative to modifying the zfs initcpio hook as mentioned in https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick.
This hook can also be used in ZFSBootMenu, meaning the same code and same usb can unlock your root pool in ZFSBootMenu and Linux itself. This solution does not store your key in initramfs.
Generate the Password + Write to the USB Generate your zfs password and put it on a usb drive using DD, see the first two steps: https://wiki."><meta property="og:type" content="article"><meta property="og:url" content="https://branchmispredictor.github.io/post/encrypted-zfs-root-key-on-usb-using-arch/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-05T23:30:42-04:00"><meta property="article:modified_time" content="2023-01-05T23:30:42-04:00"><meta property="og:site_name" content="branchmispredictor"><meta name=twitter:card content="summary"><meta name=twitter:title content="Encrypted ZFS Root Key on USB using Arch"><meta name=twitter:description content="This is an initcpio hook that loads your root pool zfs password from a usb stick, as an alternative to modifying the zfs initcpio hook as mentioned in https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick.
This hook can also be used in ZFSBootMenu, meaning the same code and same usb can unlock your root pool in ZFSBootMenu and Linux itself. This solution does not store your key in initramfs.
Generate the Password + Write to the USB Generate your zfs password and put it on a usb drive using DD, see the first two steps: https://wiki."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://branchmispredictor.github.io/post/"},{"@type":"ListItem","position":2,"name":"Encrypted ZFS Root Key on USB using Arch","item":"https://branchmispredictor.github.io/post/encrypted-zfs-root-key-on-usb-using-arch/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Encrypted ZFS Root Key on USB using Arch","name":"Encrypted ZFS Root Key on USB using Arch","description":"This is an initcpio hook that loads your root pool zfs password from a usb stick, as an alternative to modifying the zfs initcpio hook as mentioned in https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick.\nThis hook can also be used in ZFSBootMenu, meaning the same code and same usb can unlock your root pool in ZFSBootMenu and Linux itself. This solution does not store your key in initramfs.\nGenerate the Password + Write to the USB Generate your zfs password and put it on a usb drive using DD, see the first two steps: https://wiki.","keywords":["arch","linux","zfs"],"articleBody":"This is an initcpio hook that loads your root pool zfs password from a usb stick, as an alternative to modifying the zfs initcpio hook as mentioned in https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick.\nThis hook can also be used in ZFSBootMenu, meaning the same code and same usb can unlock your root pool in ZFSBootMenu and Linux itself. This solution does not store your key in initramfs.\nGenerate the Password + Write to the USB Generate your zfs password and put it on a usb drive using DD, see the first two steps: https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick.\nCreate The Initcpio Hook Create /etc/initcpio/hooks/rpoolusb and edit usb and pool (and if necessary the size/location of your password on the usb in the dd command):\n#!/bin/ash run_hook() { echo \"[rpoolusb]\" usb=\"/dev/disk/by-id/usb-Kingston_DataTraveler_3.0-0:0\" pool=\"rpool\" mkdir /zfs-key-files mount -t tmpfs key_store /zfs-key-files if [ -e \"$usb\" ]; then echo \"Loading key\" dd if=\"$usb\" of=\"/zfs-key-files/$pool\" bs=32 count=1 else echo \"Could not find usb!\" sleep 5s fi } run_cleanuphook() { echo \"[rpoolusb]\" } Create /etc/initcpio/install/rpoolusb:\n#!/bin/bash build() { map add_binary \\ udevadm map add_file \\ /lib/udev/rules.d/60-zvol.rules \\ /lib/udev/rules.d/69-vdev.rules \\ /lib/udev/rules.d/90-zfs.rules \\ /lib/libgcc_s.so.1 add_runscript } help() { cat\u003c","wordCount":"305","inLanguage":"en","datePublished":"2023-01-05T23:30:42-04:00","dateModified":"2023-01-05T23:30:42-04:00","author":{"@type":"Person","name":"branchmispredictor"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://branchmispredictor.github.io/post/encrypted-zfs-root-key-on-usb-using-arch/"},"publisher":{"@type":"Organization","name":"branchmispredictor","logo":{"@type":"ImageObject","url":"https://branchmispredictor.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://branchmispredictor.github.io/ accesskey=h title="branchmispredictor (Alt + H)">branchmispredictor</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://branchmispredictor.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://branchmispredictor.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://branchmispredictor.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://branchmispredictor.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://branchmispredictor.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://branchmispredictor.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Encrypted ZFS Root Key on USB using Arch</h1><div class=post-meta><span title='2023-01-05 23:30:42 -0400 -0400'>2023-01-05</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;branchmispredictor</div></header><div class=post-content><p>This is an initcpio hook that loads your root pool zfs password from a usb stick,
as an alternative to modifying the zfs initcpio hook as mentioned in
<a href=https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick>https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick</a>.</p><p>This hook can also be used in ZFSBootMenu, meaning the same code and same usb can unlock your
root pool in ZFSBootMenu and Linux itself. This solution does not store your key in <code>initramfs</code>.</p><h2 id=generate-the-password--write-to-the-usb>Generate the Password + Write to the USB<a hidden class=anchor aria-hidden=true href=#generate-the-password--write-to-the-usb>#</a></h2><p>Generate your zfs password and put it on a usb drive using DD, see the first two steps: <a href=https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick>https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Loading_password_from_USB-Stick</a>.</p><h2 id=create-the-initcpio-hook>Create The Initcpio Hook<a hidden class=anchor aria-hidden=true href=#create-the-initcpio-hook>#</a></h2><p>Create <code>/etc/initcpio/hooks/rpoolusb</code> and edit <code>usb</code> and <code>pool</code> (and if necessary the size/location of your password on the usb in the <code>dd</code> command):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/ash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>run_hook<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;[rpoolusb]&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>usb</span><span class=o>=</span><span class=s2>&#34;/dev/disk/by-id/usb-Kingston_DataTraveler_3.0-0:0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>pool</span><span class=o>=</span><span class=s2>&#34;rpool&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        mkdir /zfs-key-files
</span></span><span class=line><span class=cl>        mount -t tmpfs key_store /zfs-key-files
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -e <span class=s2>&#34;</span><span class=nv>$usb</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=s2>&#34;Loading key&#34;</span>
</span></span><span class=line><span class=cl>                dd <span class=k>if</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$usb</span><span class=s2>&#34;</span> <span class=nv>of</span><span class=o>=</span><span class=s2>&#34;/zfs-key-files/</span><span class=nv>$pool</span><span class=s2>&#34;</span> <span class=nv>bs</span><span class=o>=</span><span class=m>32</span> <span class=nv>count</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=s2>&#34;Could not find usb!&#34;</span>
</span></span><span class=line><span class=cl>                sleep 5s
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>run_cleanuphook<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;[rpoolusb]&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Create <code>/etc/initcpio/install/rpoolusb</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>build<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    map add_binary <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        udevadm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    map add_file <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        /lib/udev/rules.d/60-zvol.rules <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        /lib/udev/rules.d/69-vdev.rules <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        /lib/udev/rules.d/90-zfs.rules <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        /lib/libgcc_s.so.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    add_runscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>help<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    cat<span class=s>&lt;&lt;HELPEOF
</span></span></span><span class=line><span class=cl><span class=s>This hook allows you to load a zfs key from usb.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>HELPEOF</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=set-the-keylocation-for-your-zfs-pool>Set the Keylocation for Your ZFS Pool<a hidden class=anchor aria-hidden=true href=#set-the-keylocation-for-your-zfs-pool>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo zfs <span class=nb>set</span> -u <span class=nv>keylocation</span><span class=o>=</span>file:///zfs-key-files/rpool rpool
</span></span></code></pre></div><h2 id=install-the-hook-for-linux>Install the Hook for linux<a hidden class=anchor aria-hidden=true href=#install-the-hook-for-linux>#</a></h2><p>Add the hook to your mkinitcpio config at <code>/etc/mkinitcpio.conf</code>, example:</p><pre tabindex=0><code>HOOKS=(base udev autodetect modconf kms keyboard keymap consolefont block rpoolusb zfs filesystems)
</code></pre><p>Regenerate initcpio: <code>sudo mkinitcpio -P</code></p><h2 id=install-the-hook-for-zfsbootmenu>Install the Hook for ZFSBootMenu<a hidden class=anchor aria-hidden=true href=#install-the-hook-for-zfsbootmenu>#</a></h2><p>Ensure you are using ZFSBootMenu with <code>InitCPIO: true</code> following
<a href=https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Generate_a_ZFSBootMenu_image>https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Generate_a_ZFSBootMenu_image</a>.</p><p>You may have to add the following to <code>/etc/zfsbootmenu/config.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>InitCPIOHookDirs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/etc/zfsbootmenu/initcpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/etc/initcpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/usr/lib/initcpio</span><span class=w>
</span></span></span></code></pre></div><p>Add the <code>rpoolusb</code> hook to <code>/etc/zfsbootmenu/mkinitcpio.conf</code>, example:</p><pre tabindex=0><code>HOOKS=(base udev autodetect modconf block filesystems keyboard rpoolusb zfsbootmenu)
</code></pre><p>Regenerate your zfsbootmenu with <code>sudo generate-zbm</code></p><h1 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h1><ol><li><a href=https://gist.github.com/Soulsuke/6a7d1f09f7fef968a2f32e0ff32a5c4c>gist.github.com/Soulsuke/arch_on_zfs.txt</a></li><li><a href=https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS>Arch Wiki: Install Arch Linux on ZFS</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://branchmispredictor.github.io/tags/arch/>arch</a></li><li><a href=https://branchmispredictor.github.io/tags/linux/>linux</a></li><li><a href=https://branchmispredictor.github.io/tags/zfs/>zfs</a></li></ul><nav class=paginav><a class=prev href=https://branchmispredictor.github.io/post/fixing-atuin-lag-on-zfs/><span class=title>« Prev</span><br><span>Fixing Atuin Lag on Zfs</span>
</a><a class=next href=https://branchmispredictor.github.io/post/fixing-lsi-sas-card-new-kernel/><span class=title>Next »</span><br><span>Fixing LSI SAS Card After Kernel Upgrade</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://branchmispredictor.github.io/>branchmispredictor</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>