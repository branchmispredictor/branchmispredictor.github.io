<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Fixing Atuin Lag on Zfs | branchmispredictor</title>
<meta name=keywords content="arch,linux,zfs,atuin,litestream"><meta name=description content="I use atuin to keep a persistent and searchable bash history on my machine. Unfortunately, I was noticing periodic 5-10s of lag sometimes between entering a command, and seeing its response. A quick search turned up this Github issue, pointing to a ZFS bug involving sqlite (used by atuin) and ftruncate.
A helpful comment alluded to a solution by storing the atuin sqlite db on tmpfs, and syncing that sqlite DB to ZFS using litestream."><meta name=author content="branchmispredictor"><link rel=canonical href=https://branchmispredictor.github.io/post/fixing-atuin-lag-on-zfs/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://branchmispredictor.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://branchmispredictor.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://branchmispredictor.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://branchmispredictor.github.io/apple-touch-icon.png><link rel=mask-icon href=https://branchmispredictor.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Fixing Atuin Lag on Zfs"><meta property="og:description" content="I use atuin to keep a persistent and searchable bash history on my machine. Unfortunately, I was noticing periodic 5-10s of lag sometimes between entering a command, and seeing its response. A quick search turned up this Github issue, pointing to a ZFS bug involving sqlite (used by atuin) and ftruncate.
A helpful comment alluded to a solution by storing the atuin sqlite db on tmpfs, and syncing that sqlite DB to ZFS using litestream."><meta property="og:type" content="article"><meta property="og:url" content="https://branchmispredictor.github.io/post/fixing-atuin-lag-on-zfs/"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-01-05T23:15:28-05:00"><meta property="article:modified_time" content="2024-01-05T23:15:28-05:00"><meta property="og:site_name" content="branchmispredictor"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fixing Atuin Lag on Zfs"><meta name=twitter:description content="I use atuin to keep a persistent and searchable bash history on my machine. Unfortunately, I was noticing periodic 5-10s of lag sometimes between entering a command, and seeing its response. A quick search turned up this Github issue, pointing to a ZFS bug involving sqlite (used by atuin) and ftruncate.
A helpful comment alluded to a solution by storing the atuin sqlite db on tmpfs, and syncing that sqlite DB to ZFS using litestream."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://branchmispredictor.github.io/post/"},{"@type":"ListItem","position":2,"name":"Fixing Atuin Lag on Zfs","item":"https://branchmispredictor.github.io/post/fixing-atuin-lag-on-zfs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fixing Atuin Lag on Zfs","name":"Fixing Atuin Lag on Zfs","description":"I use atuin to keep a persistent and searchable bash history on my machine. Unfortunately, I was noticing periodic 5-10s of lag sometimes between entering a command, and seeing its response. A quick search turned up this Github issue, pointing to a ZFS bug involving sqlite (used by atuin) and ftruncate.\nA helpful comment alluded to a solution by storing the atuin sqlite db on tmpfs, and syncing that sqlite DB to ZFS using litestream.","keywords":["arch","linux","zfs","atuin","litestream"],"articleBody":"I use atuin to keep a persistent and searchable bash history on my machine. Unfortunately, I was noticing periodic 5-10s of lag sometimes between entering a command, and seeing its response. A quick search turned up this Github issue, pointing to a ZFS bug involving sqlite (used by atuin) and ftruncate.\nA helpful comment alluded to a solution by storing the atuin sqlite db on tmpfs, and syncing that sqlite DB to ZFS using litestream. I had heard of litestream but had never used it, and wanted to duplicate the proposed fix.\nSetup Ensure you have atuin, litestream, and screen installed.\nThe standard atuin install suggests placing this in .bashrc (if using bash-preexec):\n[[ -f ~/.bash-preexec.sh ]] \u0026\u0026 source ~/.bash-preexec.sh eval \"$(atuin init bash)\" I created an additional bash function that on the first bash session\nCreates a tmp dir Replicates the atuin db to tmpfs Setups up a background process running litestream to replicate the tmpfs sqlite db back to zfs The script function fix_atuin_zfs() { # Can remove after https://github.com/openzfs/zfs/issues/14290 gets fixed. # Also need to set ~/.config/atuin/config.toml:db_path = /tmp/$USER-atuin-db/history.db # (replace $USER with your username in config.toml) tmpfs_db_path=\"/tmp/$USER-atuin-db\" tmpfs_db_file=\"$tmpfs_db_path/history.db\" litestream_backup_path=\"$HOME/.local/share/atuin/history-db-litestream\" # Only run on first bash session for this user if mkdir \"$tmpfs_db_path\" 2\u003e/dev/null; then # Need to copy over the DB to tmp dir + run litestream if [ -d \"$litestream_backup_path\" ]; then # We've already been using litestream, use it as the source of truth for history.db litestream restore -o \"$tmpfs_db_file\" \"file://$litestream_backup_path\" \u003e /dev/null 2\u003e\u00261 else # Migrate over the initial history.db from atuin to tmpfs cp ~/.local/share/atuin/history.db* \"$tmpfs_db_path/\" fi # Run litestream replication in the background screen -S litestream-atuin-$USER -dm litestream replicate \"$tmpfs_db_file\" \"file://$litestream_backup_path\" fi } fix_atuin_zfs [[ -f ~/.bash-preexec.sh ]] \u0026\u0026 source ~/.bash-preexec.sh eval \"$(atuin init bash)\" A quick script, and hopefully not one that needs to last too long before ZFS gets a bugfix.\nMigrating Away Once ZFS is fixed, you can remove this from you .bashrc, kill the existing litestream process, and then do a final replication from the litestream backup to your normal atuin db:\nlitestream restore -o ~/.local/share/atuin/history.db ~/.local/share/atuin/history-db-litestream ","wordCount":"350","inLanguage":"en","datePublished":"2024-01-05T23:15:28-05:00","dateModified":"2024-01-05T23:15:28-05:00","author":{"@type":"Person","name":"branchmispredictor"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://branchmispredictor.github.io/post/fixing-atuin-lag-on-zfs/"},"publisher":{"@type":"Organization","name":"branchmispredictor","logo":{"@type":"ImageObject","url":"https://branchmispredictor.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://branchmispredictor.github.io/ accesskey=h title="branchmispredictor (Alt + H)">branchmispredictor</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://branchmispredictor.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://branchmispredictor.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://branchmispredictor.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://branchmispredictor.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://branchmispredictor.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://branchmispredictor.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Fixing Atuin Lag on Zfs</h1><div class=post-meta><span title='2024-01-05 23:15:28 -0500 -0500'>2024-01-05</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;branchmispredictor</div></header><div class=post-content><p>I use atuin to keep a persistent and searchable bash history on my machine.
Unfortunately, I was noticing periodic 5-10s of lag sometimes between entering a command, and seeing its response.
A quick search turned up <a href=https://github.com/atuinsh/atuin/issues/952>this Github issue</a>, pointing to a <a href=https://github.com/openzfs/zfs/issues/14290>ZFS bug</a> involving sqlite (used by atuin) and ftruncate.</p><p>A <a href=https://github.com/atuinsh/atuin/issues/952#issuecomment-1645436046>helpful comment</a> alluded to a solution by storing the atuin sqlite db on tmpfs, and syncing that sqlite DB to ZFS using <code>litestream</code>. I had heard of litestream but had never used it, and wanted to duplicate the proposed fix.</p><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>Ensure you have <code>atuin</code>, <code>litestream</code>, and <code>screen</code> installed.</p><p>The standard atuin install suggests placing this in <code>.bashrc</code> (if using bash-preexec):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[[</span> -f ~/.bash-preexec.sh <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nb>source</span> ~/.bash-preexec.sh
</span></span><span class=line><span class=cl><span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>atuin init bash<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>I created an additional bash function that on the first bash session</p><ol><li>Creates a tmp dir</li><li>Replicates the atuin db to tmpfs</li><li>Setups up a background process running litestream to replicate the tmpfs sqlite db back to zfs</li></ol><h2 id=the-script>The script<a hidden class=anchor aria-hidden=true href=#the-script>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>function</span> fix_atuin_zfs<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># Can remove after https://github.com/openzfs/zfs/issues/14290 gets fixed.</span>
</span></span><span class=line><span class=cl>  <span class=c1># Also need to set ~/.config/atuin/config.toml:db_path = /tmp/$USER-atuin-db/history.db</span>
</span></span><span class=line><span class=cl>  <span class=c1># (replace $USER with your username in config.toml)</span>
</span></span><span class=line><span class=cl>  <span class=nv>tmpfs_db_path</span><span class=o>=</span><span class=s2>&#34;/tmp/</span><span class=nv>$USER</span><span class=s2>-atuin-db&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>tmpfs_db_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$tmpfs_db_path</span><span class=s2>/history.db&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>litestream_backup_path</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.local/share/atuin/history-db-litestream&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Only run on first bash session for this user</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> mkdir <span class=s2>&#34;</span><span class=nv>$tmpfs_db_path</span><span class=s2>&#34;</span> 2&gt;/dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Need to copy over the DB to tmp dir + run litestream</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -d <span class=s2>&#34;</span><span class=nv>$litestream_backup_path</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=c1># We&#39;ve already been using litestream, use it as the source of truth for history.db</span>
</span></span><span class=line><span class=cl>      litestream restore -o <span class=s2>&#34;</span><span class=nv>$tmpfs_db_file</span><span class=s2>&#34;</span> <span class=s2>&#34;file://</span><span class=nv>$litestream_backup_path</span><span class=s2>&#34;</span> &gt; /dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=c1># Migrate over the initial history.db from atuin to tmpfs</span>
</span></span><span class=line><span class=cl>      cp ~/.local/share/atuin/history.db* <span class=s2>&#34;</span><span class=nv>$tmpfs_db_path</span><span class=s2>/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=c1># Run litestream replication in the background</span>
</span></span><span class=line><span class=cl>    screen -S litestream-atuin-<span class=nv>$USER</span> -dm litestream replicate <span class=s2>&#34;</span><span class=nv>$tmpfs_db_file</span><span class=s2>&#34;</span> <span class=s2>&#34;file://</span><span class=nv>$litestream_backup_path</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>fix_atuin_zfs
</span></span><span class=line><span class=cl><span class=o>[[</span> -f ~/.bash-preexec.sh <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nb>source</span> ~/.bash-preexec.sh
</span></span><span class=line><span class=cl><span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>atuin init bash<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>A quick script, and hopefully not one that needs to last too long before ZFS gets a bugfix.</p><h2 id=migrating-away>Migrating Away<a hidden class=anchor aria-hidden=true href=#migrating-away>#</a></h2><p>Once ZFS is fixed, you can remove this from you <code>.bashrc</code>, kill the existing litestream process, and then do a final replication from the litestream backup to your normal atuin db:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>litestream restore -o ~/.local/share/atuin/history.db ~/.local/share/atuin/history-db-litestream
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://branchmispredictor.github.io/tags/arch/>arch</a></li><li><a href=https://branchmispredictor.github.io/tags/linux/>linux</a></li><li><a href=https://branchmispredictor.github.io/tags/zfs/>zfs</a></li><li><a href=https://branchmispredictor.github.io/tags/atuin/>atuin</a></li><li><a href=https://branchmispredictor.github.io/tags/litestream/>litestream</a></li></ul><nav class=paginav><a class=next href=https://branchmispredictor.github.io/post/encrypted-zfs-root-key-on-usb-using-arch/><span class=title>Next »</span><br><span>Encrypted ZFS Root Key on USB using Arch</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://branchmispredictor.github.io/>branchmispredictor</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>